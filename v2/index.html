<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta charset="utf-8" />
    <title>SF Planning Impact Fee Calculator</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="styles/reset.css" />
    <link rel="stylesheet" href="styles/colors.css" />
    <link rel="stylesheet" href="styles/print.css" />
    <link rel="stylesheet" href="styles/style.css" />

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

    <script>
      // setup to track the different inputs
      var loc;
      var units_proposed, units_existing, units_net;
      var resGSF_proposed, resGSF_existing, units_net;
      var nonResGSF_proposed, nonResGSF_existing, nonResGSF_net;

      var total;

      var fees_all;
      var fees_applicable, fees_nonApplicable;

      var example_bikeFee = {
        label: "Bicycle Parking In-Lieu Fee",
        section: { name: "430", link: "#" },
        inputs: [
          {
            label: "Class 2 bicycle parking spots",
            units: "parking spots",
          },
        ],
        // right hand calculations for now
        // we may need a different serialization for the computations
        calculations: [
          {
            label: "Bicycle Parking In-Lieu Fee",
            amount: "$ 649.58",
          },
        ],
      };

      var openSpaceFee = {
        label: "Open Space Fee in EN Mixed-Use and C-3-0 (SD) Districts",
        section: { name: "426", link: "#" },
        inputs: [
          {
            label: "Required open space",
            units: "sqft",
          },
          {
            label: "Provided open space",
            units: "sqft",
          },
        ],
        calculations: [
          {
            label: "Eastern Neighborhoods Mixed Use District fee",
            amount: "$ 142.66 / sqft",
          },
          {
            label: "Central SOMA SUD fee",
            amount: "$ 1,113.77 / sqft",
          },
        ],
      };

      class FeeCard {
        constructor(feeData) {
          this.data = feeData;
          this.state = {
            inputs: Array(feeData.inputs.length).fill(0),
            totalFee: 0,
          };
          this.element = this.createCard();
          this.setupEventListeners();
        }

        createCard() {
          // Clone the template using jQuery
          const $template = $("#fee-card-template").contents().clone();

          // Fill in the basic info using jQuery
          $template.find(".fee-title").text(this.data.label);
          $template.find(".fee-section").text(this.data.section.name);
          $template
            .find(".fee-section-link")
            .attr("href", this.data.section.link);
          $template.find(".fee-summary-label").text(this.data.label);
          $template
            .find(".fee-summary-amount")
            .text(this.data.calculations[0].amount);

          // Add inputs
          const $inputsContainer = $template.find(".card-inputs");
          this.data.inputs.forEach((input) => {
            const $inputElement = $("#fee-input-template").contents().clone();

            $inputElement.find("label").text(input.label);
            $inputElement.find(".input-units").text(input.units);

            $inputsContainer.append($inputElement);
          });

          return $template;
        }

        setupEventListeners() {
          // jQuery event handling
          this.element.find("input").on("input", (e) => {
            const $input = $(e.target);
            const index = this.element.find("input").index($input);

            const newInputs = [...this.state.inputs];
            newInputs[index] = parseFloat($input.val()) || 0;
            this.setState({ inputs: newInputs });
          });
        }

        setState(newState) {
          this.state = { ...this.state, ...newState };
          this.updateView();
        }

        calculateFee() {
          // Example calculation - modify based on your needs
          return this.state.inputs.reduce((sum, val) => sum + val, 0) * 649.58;
        }

        updateView() {
          const fee = this.calculateFee();
          this.element.find(".fee-amount").text(`$ ${fee.toFixed(2)}`);
          this.element.find(".fee-summary-amount").text(`$ ${fee.toFixed(2)}`);
        }

        mount($container) {
          $container.append(this.element);
        }
      }

      // Wait for DOM to be ready using jQuery
      $(document).ready(() => {
        // Clear existing example cards
        $(".fees-ctr").empty();

        // Create and mount fee cards
        console.log("-- here");
        const bikeCard = new FeeCard(example_bikeFee);
        const openSpaceCard = new FeeCard(openSpaceFee);

        bikeCard.mount($(".fees-ctr"));
        openSpaceCard.mount($(".fees-ctr"));
      });
    </script>
  </head>

  <body>
    <div class="ctr">
      <div class="header">
        <h1>2024 SF planning impact fee calculator</h1>
        <p class="subheader-text">
          All calculations are made according to the
          <a href="#">2024 SF impact fee register</a>. View fee registers of
          previous years here.
        </p>
      </div>

      <div class="base-inputs-ctr">
        <div class="base-inputs-header">
          <h2>Initial Information</h2>
          <p class="subheader-text">
            Fill in the fields below to start calculating fees. For GFA,
            calculate as defined in
            <a href="#">Sec. 401</a> rather than as defined in
            <a href="#">Sec. 102</a>.
          </p>
        </div>
        <div class="base-inputs-body">
          <div>
            <div>Street Address</div>
            <input placeholder="123 Str" style="width: 100%" />
          </div>
          <div class="base-inputs-row">
            <div>Units</div>
            <div>
              <div>Proposed</div>
              <div class="input-ctr">
                <input placeholder="0" type="number" />
                <span>units</span>
              </div>
            </div>
            <div>
              <div>Proposed</div>
              <div class="input-ctr">
                <input placeholder="0" type="number" />
                <span>units</span>
              </div>
            </div>
            <div>
              <div>Net</div>
              <div class="input-ctr">
                <input placeholder="0" type="number" disabled="true" />
                <span>units</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="fees-ctr"></div>
    </div>

    <!-- Add templates at the start of body -->
    <template id="fee-card-template">
      <div class="fee-row">
        <div class="card">
          <div class="card-header">
            <h4>
              <span class="fee-title"></span> (<a
                href="#"
                class="fee-section-link"
                >Sec. <span class="fee-section"></span></a
              >)
            </h4>
          </div>
          <div class="card-inputs"></div>
          <div class="card-fee">
            <h6>Fee</h6>
            <p class="fee-amount">$ 0.00</p>
            <div class="card-calculations">
              <button class="show-calculations">Show Calculations</button>
              <div class="calculations-detail" style="display: none"></div>
            </div>
          </div>
        </div>
        <div class="fee-row-summary">
          <div class="fee-summary-label"></div>
          <div class="fee-summary-amount">$ 0.00</div>
        </div>
      </div>
    </template>

    <template id="fee-input-template">
      <div class="input-group">
        <label></label>
        <div class="input-ctr">
          <input placeholder="0" type="number" min="0" />
          <span class="input-units"></span>
        </div>
      </div>
    </template>
  </body>
</html>
